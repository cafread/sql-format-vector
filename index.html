<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      main {
        overflow: hidden;
        display: flex;
        flex-direction: row;
        -webkit-align-items: stretch;
        align-items: stretch;
        height: calc(100% - 2px);
      }
      .input,
      .output {
        display: flex;
        -webkit-align-items: stretch;
        align-items: stretch;
        width: 50%;
        height: 100%;
      }
      .output {
        border-left: 2px solid #8dc63f;
      }
      textarea {
        width: 100%;
        padding: 20px;
        border: 0;
        box-sizing: border-box;
        resize: none;
        outline: none;
      }
    </style>
    <link rel="stylesheet" href="lib/codemirror.css">
    <script src="lib/codemirror.js"></script>
    <script src="lib/codemirror-sql.js"></script>
    <script type="text/javascript" src="constants.js"></script>
    <script type="text/javascript" src="sqlFormatter.js"></script>
  </head>
  <body>
    <main>
      <section class="input">
        <textarea id="input" autofocus="true" wrap="off">/*Paste your code here, or just start writing!*/</textarea>
      </section>
      <section class="output">
        <textarea id="output" readonly="true" wrap="off">/*Formatted output will appear here*/</textarea>
      </section>
    </main>
    <script>
      window.input = CodeMirror.fromTextArea(document.getElementById('input'), {
        mode: 'text/x-pgsql',
        indentWithTabs: false,
        smartIndent: false,
        lineNumbers: true,
        matchBrackets : true,
        autofocus: false,
        tabSize: 2
      });
      window.output = CodeMirror.fromTextArea(document.getElementById('output'), {
        mode: 'text/x-pgsql',
        indentWithTabs: false,
        smartIndent: false,
        lineNumbers: true,
        matchBrackets : true,
        autofocus: false,
        tabSize: 2
      });
      function format() {
        let inp = input.doc.getValue();
        let endsWithSc = inp.replace(/\s/gm, '').slice(-1) === ';';
        // To improve performance when dealing with many queries at once and making edits, split into individual queries and cache results
        // Find all non-commented ; and split into individual queries
        // To avoid a super complex regex, replacing commented ';' with 'ỿ' temporarily
        let queries = input.doc.getValue().replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\-\-.*$ /gm, v => v.replaceAll(';', 'ỿ')).split(';').map(v => v.replaceAll('ỿ', ';'));
        for (let q of queries.filter(v => !queryCache.hasOwnProperty(v))) queryCache[q] = sqlFormatter.format(q + ';', {language: 'sql', uppercase: true});
        let out = queries.map(q => queryCache[q]).join('\n');
        out =  endsWithSc ? out : out.slice(0, out.length - 1);
        output.doc.setValue(out);
      }
      CodeMirror.on(input, 'change', format);
    </script>
  </body>
</html>
